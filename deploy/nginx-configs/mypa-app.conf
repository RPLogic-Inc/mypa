# Rate limiting zones
limit_req_zone $binary_remote_addr zone=app_api_limit:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=app_auth_limit:10m rate=30r/m;

# HTTP → HTTPS redirect
server {
    listen 80;
    listen [::]:80;
    server_name app.mypa.chat api.mypa.chat;
    return 301 https://$host$request_uri;
}

# ─────────────────────────────────────────────────────────────────────
# api.mypa.chat — API-only proxy (used by Canvas, skills, clients)
# ─────────────────────────────────────────────────────────────────────
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name api.mypa.chat;

    ssl_certificate /etc/letsencrypt/live/app.mypa.chat/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/app.mypa.chat/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;

    include /etc/nginx/snippets/security-headers.conf;
    server_tokens off;

    # Tezit Protocol discovery
    location /.well-known/ {
        proxy_pass http://127.0.0.1:3001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # API proxy to MyPA backend
    location /api/ {
        limit_req zone=app_api_limit burst=20;
        proxy_pass http://127.0.0.1:3001;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        client_max_body_size 25M;
    }

    # Backend health endpoints
    location /health/ {
        proxy_pass http://127.0.0.1:3001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # Auth endpoints (stricter limit)
    location /api/auth/ {
        limit_req zone=app_auth_limit burst=5;
        proxy_pass http://127.0.0.1:3001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # WebSocket for PA chat
    location /api/pa/ws {
        proxy_pass http://127.0.0.1:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_read_timeout 86400s;
    }

    # PA Workspace API
    location /api/pa-workspace/ {
        proxy_pass http://127.0.0.1:3003/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # Tezit Relay proxy
    location /relay/ {
        proxy_pass http://10.108.0.2:3002/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        client_max_body_size 2M;
    }

    # SECURITY: Block direct Gateway access from the API domain
    location /v1/ {
        return 403 "Direct Gateway access forbidden. Use /api/openclaw/*.";
    }
    location /__openclaw__/ {
        return 403 "OpenClaw canvas is not served from this domain.";
    }

    # Deny sensitive files
    location ~ /\.(env|db|db-journal) {
        deny all;
    }

    # Anything else on api.mypa.chat → redirect to oc.mypa.chat
    location / {
        return 301 https://oc.mypa.chat$request_uri;
    }
}

# ─────────────────────────────────────────────────────────────────────
# app.mypa.chat — Canvas SPA with split API proxies
# ─────────────────────────────────────────────────────────────────────
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name app.mypa.chat;

    ssl_certificate /etc/letsencrypt/live/app.mypa.chat/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/app.mypa.chat/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;

    include /etc/nginx/snippets/security-headers.conf;
    server_tokens off;

    # Canvas SPA root
    root /var/mypa/app-canvas;
    index index.html;

    # Tezit Protocol discovery
    location /.well-known/ {
        proxy_pass http://127.0.0.1:3001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # Backend health endpoints
    location /health/ {
        proxy_pass http://127.0.0.1:3001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # Backend API routes (specific prefixes → :3001, must come before catch-all /api/)
    location ^~ /api/auth/ {
        limit_req zone=app_auth_limit burst=5;
        proxy_pass http://127.0.0.1:3001;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    location ^~ /api/users/ {
        proxy_pass http://127.0.0.1:3001;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    location ^~ /api/cards/ {
        proxy_pass http://127.0.0.1:3001;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    location ^~ /api/crm/ {
        proxy_pass http://127.0.0.1:3001;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    location ^~ /api/library/ {
        proxy_pass http://127.0.0.1:3001;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    location ^~ /api/pa/ {
        proxy_pass http://127.0.0.1:3001;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    location ^~ /api/settings/ {
        proxy_pass http://127.0.0.1:3001;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    location ^~ /api/openclaw/ {
        proxy_pass http://127.0.0.1:3001;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 120s;
    }
    location ^~ /api/invites/ {
        proxy_pass http://127.0.0.1:3001;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    location ^~ /api/onboarding/ {
        proxy_pass http://127.0.0.1:3001;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Remaining /api/* → Tezit Relay :3002 (strip /api/ prefix)
    location /api/ {
        limit_req zone=app_api_limit burst=20;
        rewrite ^/api/(.*)$ /$1 break;
        proxy_pass http://10.108.0.2:3002;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 86400s;
        client_max_body_size 2M;
    }

    # Tezit Relay proxy (legacy /relay/ path)
    location /relay/ {
        proxy_pass http://10.108.0.2:3002/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        client_max_body_size 2M;
    }

    # SECURITY: Block direct Gateway access from the app domain
    location /v1/ {
        return 403 "Direct Gateway access forbidden.";
    }

    # Deny sensitive files
    location ~ /\.(env|db|db-journal) {
        deny all;
    }

    # Static asset caching
    location /assets/ {
        expires 1h;
        add_header Cache-Control "public, immutable";
    }

    # SPA fallback — all other paths serve index.html for client-side routing
    location / {
        try_files $uri $uri/ /index.html;
    }
}
